apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      # Configure SMTP for email notifications (example with Gmail)
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'kubernetes-alerts@example.com'
      smtp_auth_username: 'kubernetes-alerts@example.com'
      smtp_auth_password: 'your-app-password'
      smtp_require_tls: true
    
    # Routing configuration
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 12h
      receiver: 'default-receiver'
      routes:
      - match:
          severity: critical
        receiver: critical-alerts
        group_wait: 0s
        repeat_interval: 5m
      - match:
          severity: warning
        receiver: warning-alerts
        repeat_interval: 1h
    
    # Notification receivers
    receivers:
    - name: 'default-receiver'
      webhook_configs:
      - url: 'http://httpbin.org/post'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'webhook-user'
            password: 'webhook-password'
        title: 'Kubernetes Alert - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Instance: {{ .Labels.instance }}
          {{ end }}
    
    - name: critical-alerts
      email_configs:
      - to: 'admin@example.com'
        subject: '[CRITICAL] Kubernetes Alert: {{ .GroupLabels.alertname }}'
        body: |
          <h2>üö® Critical Alert</h2>
          {{ range .Alerts }}
          <p><strong>Alert:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
          <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
          <p><strong>Started:</strong> {{ .StartsAt }}</p>
          {{ if .EndsAt }}<p><strong>Ended:</strong> {{ .EndsAt }}</p>{{ end }}
          <hr>
          {{ end }}
        headers:
          Content-Type: 'text/html'
      webhook_configs:
      - url: 'http://httpbin.org/post'
        send_resolved: true
        title: '[CRITICAL] {{ .GroupLabels.alertname }}'
        text: |
          üö® CRITICAL ALERT üö®
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          {{ end }}
    
    - name: warning-alerts
      webhook_configs:
      - url: 'http://httpbin.org/post'
        send_resolved: true
        title: '[WARNING] {{ .GroupLabels.alertname }}'
        text: |
          ‚ö†Ô∏è WARNING ALERT ‚ö†Ô∏è
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          {{ end }}
    
    # Inhibition rules to prevent spam
    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'cluster', 'service']